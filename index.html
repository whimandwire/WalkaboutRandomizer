<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Walkabout Mini Golf Randomizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    p.helper {
      color: #9ca3af;
      font-size: 0.9rem;
      margin-top: 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid #1e293b;
      box-shadow: 0 16px 40px rgba(15,23,42,0.6);
    }
    .courses-list {
      max-height: 320px;
      overflow: auto;
      padding-right: 4px;
    }
    .courses-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 2px 0;
      font-size: 0.9rem;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #0b1120;
      border: 1px solid #1e293b;
      font-size: 0.85rem;
    }
    .pill input {
      margin: 0;
    }
    .controls-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.9rem;
    }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
    }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      padding-inline: 20px;
      font-size: 1rem;
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .footer-row {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .result-card {
      margin-top: 20px;
      padding: 16px 18px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(45,212,191,0.15), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(59,130,246,0.18), transparent 60%),
                  #020617;
      border: 1px solid #22c55e40;
    }
    .result-card h2 {
      margin-top: 0;
      margin-bottom: 8px;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px 18px;
      font-size: 0.95rem;
    }
    .result-label {
      color: #9ca3af;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .result-value {
      font-size: 1rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(22,163,74,0.5);
      font-size: 0.8rem;
      color: #bbf7d0;
    }
    .error {
      margin-top: 10px;
      color: #fecaca;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }
    small.note {
      display: block;
      color: #9ca3af;
      font-size: 0.8rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Walkabout Mini Golf Randomizer</h1>
      <p class="helper">
        Toggle whatâ€™s in the mix, then roll for a randomized round:
        course, difficulty, holes, game mode, turn order, player scale, and gravity.
        New courses added to the Google Sheet appear automatically when you reload.
      </p>
    </header>

    <section class="grid">
      <!-- Courses -->
      <div class="card">
        <h2>Courses</h2>
        <p class="helper">Uncheck any course you donâ€™t own or donâ€™t feel like playing.</p>
        <div class="controls-row">
          <button type="button" class="btn-secondary" id="selectAllCourses">Select all</button>
          <button type="button" class="btn-secondary" id="clearAllCourses">Clear all</button>
          <button type="button" class="btn-secondary" id="baseGameOnly">Base game only</button>
        </div>
        <div class="courses-list" id="coursesContainer"></div>
      </div>

      <!-- Difficulty & Holes -->
      <div class="card">
        <h2>Difficulty &amp; Holes</h2>
        <div>
          <div class="pill-row" id="difficultyOptions">
            <label class="pill">
              <input type="checkbox" id="difficulty-normal" checked />
              <span>Normal</span>
            </label>
            <label class="pill">
              <input type="checkbox" id="difficulty-hard" checked />
              <span>Hard</span>
            </label>
          </div>
        </div>
        <div style="margin-top: 14px;">
          <div class="helper" style="margin-bottom: 4px;">Number of holes</div>
          <label class="pill">
            <input type="radio" name="holes" value="18" checked />
            <span>Always full 18</span>
          </label>
          <label class="pill">
            <input type="radio" name="holes" value="9" />
            <span>Always 9 (front/back random)</span>
          </label>
          <label class="pill">
            <input type="radio" name="holes" value="either" />
            <span>Either 18 or 9</span>
          </label>
        </div>
        <small class="note">
          If a 9-hole round is chosen, the randomizer will decide front or back 9.
        </small>
      </div>

      <!-- Game Mode & Turn Order -->
      <div class="card">
        <h2>Game Mode &amp; Turn Order</h2>
        <div>
          <div class="helper">Game modes</div>
          <div class="pill-row" id="modeOptions"></div>
        </div>
        <div style="margin-top: 10px;">
          <div class="helper">Turn order</div>
          <div class="pill-row" id="turnOrderOptions"></div>
          <small class="note">
            Race is always simultaneous. Practice has no turn order.
          </small>
        </div>
      </div>

      <!-- Player Scale & Gravity -->
      <div class="card">
        <h2>Player Scale &amp; Gravity</h2>
        <div>
          <div class="helper">Player scale</div>
          <div class="pill-row" id="scaleOptions"></div>
        </div>
        <div style="margin-top: 10px;">
          <div class="helper">Gravity</div>
          <div class="pill-row" id="gravityOptions"></div>
        </div>
        <small class="note">
          Only options supported by the selected course(s) will be used when randomizing.
        </small>
      </div>
    </section>

    <div class="footer-row">
      <div>
        <button type="button" class="btn-primary" id="randomizeBtn" disabled>Loading coursesâ€¦</button>
      </div>
      <div style="flex: 1;">
        <p class="helper" style="margin: 0;">
          Pro tip: tweak the toggles between rolls to dial in chaos vs. comfort.
        </p>
      </div>
    </div>

    <div id="error" class="error" style="display:none;"></div>
    <div id="result"></div>
  </div>

  <!-- Papa Parse for CSV handling -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /***********************
     * 1. Config
     ***********************/
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnSGhKsRhiZJ75ArXHne_gJRwl0jVbpXwKZ8HYi0L_FtcRv2dzuHmlydbdkbaRCyVfo_SY8yRU6DGl/pub?output=csv";

    const MODE_LABELS    = ["Standard", "Closest Putt", "Match Play", "Race", "Practice"];
    const TURN_LABELS    = ["Honors", "Distance", "Consistent", "Simultaneous"];
    const SCALE_LABELS   = ["Normal", "Mini", "Giant"];
    const GRAVITY_LABELS = ["Normal", "High", "Low"];

    // Official base-game course names:
    const BASE_GAME_COURSE_NAMES = [
      "Tourist Trap",
      "Cherry Blossom",
      "Seagull Stacks",
      "Arizona Modern",
      "Original Gothic",
      "Bogey's Bonanza",
      "Tethys Station",
      "Quixote Valley",
      "Shangri-La",
      "Sweetopia",
      "20,000 Leagues",
      "Upside Town",
      "Laser Lair",
      "Alfheim"
    ];

    let COURSES = [];

    /***********************
     * 2. CSV â†’ COURSES (using column indexes)
     ***********************/
    function loadCoursesFromCSV() {
      const randomizeBtn = document.getElementById("randomizeBtn");
      showError("");

      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          const rows = results.data;

          // rows[0] = header row ("Modifiers >", "Game Mode", ...)
          // rows[1] = second header row ("Courses", "Standard", ...)
          // course data starts at index 2
          const dataRows = rows.slice(2);

          function tf(v) {
            const s = String(v || "").trim().toUpperCase();
            return s === "TRUE" || s === "âœ”" || s === "âœ…" || s === "YES" || s === "Y";
          }

          COURSES = dataRows
            .filter(row => row[0] && String(row[0]).trim() !== "")
            .map(row => {
              const name = String(row[0]).trim();   // A

              return {
                name,
                modes: {
                  "Standard":     tf(row[1]),  // B
                  "Closest Putt": tf(row[2]),  // C
                  "Match Play":   tf(row[3]),  // D
                  "Race":         tf(row[4]),  // E
                  "Practice":     tf(row[5])   // F
                },
                turnOrders: {
                  "Honors":       tf(row[6]),  // G
                  "Distance":     tf(row[7]),  // H
                  "Consistent":   tf(row[8]),  // I
                  "Simultaneous": tf(row[9])   // J
                },
                scales: {
                  "Normal": tf(row[10]), // K
                  "Mini":   tf(row[11]), // L
                  "Giant":  tf(row[12])  // M
                },
                gravities: {
                  "Normal": tf(row[13]), // N
                  "High":   tf(row[14]), // O
                  "Low":    tf(row[15])  // P
                }
              };
            });

          if (COURSES.length === 0) {
            showError("No courses found in the CSV. Check that the sheet is published with the same structure.");
            randomizeBtn.disabled = true;
            randomizeBtn.textContent = "Randomize Round";
            return;
          }

          renderCourses();
          // Auto-select base game courses on load
          autoSelectBaseGameCourses();

          randomizeBtn.disabled = false;
          randomizeBtn.textContent = "Randomize Round";
        },
        error: function(err) {
          showError("Failed to load course data from Google Sheets.\n" + err);
          randomizeBtn.disabled = true;
          randomizeBtn.textContent = "Randomize Round";
        }
      });
    }

    /***********************
     * 3. UI helpers
     ***********************/
    function createCheckboxPills(containerId, labels, groupIdPrefix, checked = true) {
      const container = document.getElementById(containerId);
      labels.forEach(label => {
        const id = groupIdPrefix + "-" + label.replace(/\s+/g, "-").toLowerCase();
        const pill = document.createElement("label");
        pill.className = "pill";
        pill.innerHTML = `
          <input type="checkbox" id="${id}" data-value="${label}" ${checked ? "checked" : ""} />
          <span>${label}</span>
        `;
        container.appendChild(pill);
      });
    }

    function getCheckedValues(prefix, labels) {
      const active = new Set();
      labels.forEach(label => {
        const id = prefix + "-" + label.replace(/\s+/g, "-").toLowerCase();
        const input = document.getElementById(id);
        if (input && input.checked) active.add(label);
      });
      return active;
    }

    function getHolesPreference() {
      const radios = document.querySelectorAll("input[name='holes']");
      for (const r of radios) {
        if (r.checked) return r.value;
      }
      return "18";
    }

    function pickRandom(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function renderCourses() {
      const container = document.getElementById("coursesContainer");
      container.innerHTML = "";
      COURSES.forEach((course, idx) => {
        const id = "course-" + idx;
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-name="${course.name}" checked />
          <span>${course.name}</span>
        `;
        container.appendChild(label);
      });
    }

    function autoSelectBaseGameCourses() {
      const boxes = document.querySelectorAll("#coursesContainer input[type=checkbox]");
      boxes.forEach((box, idx) => {
        const name = COURSES[idx].name.trim();
        box.checked = BASE_GAME_COURSE_NAMES.includes(name);
      });
    }

    function getSelectedCourses() {
      const boxes = document.querySelectorAll("#coursesContainer input[type=checkbox]");
      const selected = [];
      boxes.forEach((box, idx) => {
        if (box.checked) selected.push(COURSES[idx]);
      });
      return selected;
    }

    function showError(message) {
      const errEl = document.getElementById("error");
      if (!message) {
        errEl.style.display = "none";
        errEl.textContent = "";
      } else {
        errEl.style.display = "block";
        errEl.textContent = message;
      }
    }

    function renderResult(result) {
      const container = document.getElementById("result");
      if (!result) {
        container.innerHTML = "";
        return;
      }

      const holesLabel = result.holesType === "18"
        ? "18 (full course)"
        : result.whichNine
          ? `9 holes (${result.whichNine} 9)`
          : "9 holes";

      const turnLabel = result.turnOrder;

      container.innerHTML = `
        <div class="result-card">
          <h2>ðŸš€ Your Randomized Round</h2>
          <div style="margin-bottom: 8px;">
            <span class="badge">
              <span>Course</span>
              <strong>${result.course}</strong>
            </span>
          </div>
          <div class="result-grid">
            <div>
              <div class="result-label">Difficulty</div>
              <div class="result-value">${result.difficulty}</div>
            </div>
            <div>
              <div class="result-label">Game mode</div>
              <div class="result-value">${result.mode}</div>
            </div>
            <div>
              <div class="result-label">Turn order</div>
              <div class="result-value">${turnLabel}</div>
            </div>
            <div>
              <div class="result-label">Player scale</div>
              <div class="result-value">${result.scale}</div>
            </div>
            <div>
              <div class="result-label">Gravity</div>
              <div class="result-value">${result.gravity}</div>
            </div>
            <div>
              <div class="result-label">Holes</div>
              <div class="result-value">${holesLabel}</div>
            </div>
          </div>
        </div>
      `;
    }

    /***********************
     * 4. Unbiased randomization logic (course-first)
     ***********************/
    function randomize() {
      showError("");
      renderResult(null);

      const selectedCourses = getSelectedCourses();
      if (selectedCourses.length === 0) {
        showError("Select at least one course to randomize.");
        return;
      }

      // User-allowed options
      const allowedModes     = getCheckedValues("mode",  MODE_LABELS);
      const allowedTurns     = getCheckedValues("turn",  TURN_LABELS);
      const allowedScales    = getCheckedValues("scale", SCALE_LABELS);
      const allowedGravities = getCheckedValues("gravity", GRAVITY_LABELS);

      const difficultyOptions = [];
      if (document.getElementById("difficulty-normal").checked) difficultyOptions.push("Normal");
      if (document.getElementById("difficulty-hard").checked)  difficultyOptions.push("Hard");

      if (difficultyOptions.length === 0) {
        showError("Enable at least one difficulty (Normal and/or Hard).");
        return;
      }
      if (allowedModes.size === 0) {
        showError("Enable at least one game mode.");
        return;
      }
      if (allowedScales.size === 0) {
        showError("Enable at least one player scale option.");
        return;
      }
      if (allowedGravities.size === 0) {
        showError("Enable at least one gravity option.");
        return;
      }

      const holesPref = getHolesPreference();

      let attempts = 0;
      let chosen = null;

      while (attempts < 500 && !chosen) {
        attempts++;

        // 1ï¸âƒ£ Pick a course first (unbiased)
        const course = pickRandom(selectedCourses);

        // 2ï¸âƒ£ Valid options = user toggles âˆ© course-supported

        // Game modes
        const possibleModes = MODE_LABELS.filter(m =>
          allowedModes.has(m) && course.modes[m]
        );
        if (possibleModes.length === 0) {
          // user blocked all modes this course supports â†’ reroll course
          continue;
        }
        const mode = pickRandom(possibleModes);

        // Turn order
        let turnOrder;
        if (mode === "Practice") {
          turnOrder = "None (practice mode)";
        } else if (mode === "Race") {
          turnOrder = "Simultaneous (race)";
          if (!course.turnOrders["Simultaneous"]) continue;
        } else {
          const possibleTurns = TURN_LABELS.filter(t =>
            allowedTurns.has(t) && course.turnOrders[t]
          );
          if (possibleTurns.length === 0) {
            continue; // toggles blocked all this course's turn orders
          }
          turnOrder = pickRandom(possibleTurns);
        }

        // Player scale
        const possibleScales = SCALE_LABELS.filter(s =>
          allowedScales.has(s) && course.scales[s]
        );
        if (possibleScales.length === 0) continue;
        const scale = pickRandom(possibleScales);

        // Gravity
        const possibleGravities = GRAVITY_LABELS.filter(g =>
          allowedGravities.has(g) && course.gravities[g]
        );
        if (possibleGravities.length === 0) continue;
        const gravity = pickRandom(possibleGravities);

        // Difficulty
        const difficulty = pickRandom(difficultyOptions);

        // Holes
        let holesType = "18";
        let whichNine = null;

        if (holesPref === "18") {
          holesType = "18";
        } else if (holesPref === "9") {
          holesType = "9";
          whichNine = Math.random() < 0.5 ? "front" : "back";
        } else {
          if (Math.random() < 0.5) {
            holesType = "18";
          } else {
            holesType = "9";
            whichNine = Math.random() < 0.5 ? "front" : "back";
          }
        }

        chosen = {
          course: course.name,
          difficulty,
          mode,
          turnOrder,
          scale,
          gravity,
          holesType,
          whichNine
        };
      }

      if (!chosen) {
        showError("No valid combination found with current settings. Try enabling more modes or turn orders.");
      } else {
        renderResult(chosen);
      }
    }

    /***********************
     * 5. Bootstrap
     ***********************/
    createCheckboxPills("modeOptions", MODE_LABELS, "mode", true);
    createCheckboxPills("turnOrderOptions", TURN_LABELS, "turn", true);
    createCheckboxPills("scaleOptions", SCALE_LABELS, "scale", true);
    createCheckboxPills("gravityOptions", GRAVITY_LABELS, "gravity", true);

    loadCoursesFromCSV();

    document.getElementById("selectAllCourses").addEventListener("click", () => {
      document
        .querySelectorAll("#coursesContainer input[type=checkbox]")
        .forEach(box => box.checked = true);
    });

    document.getElementById("clearAllCourses").addEventListener("click", () => {
      document
        .querySelectorAll("#coursesContainer input[type=checkbox]")
        .forEach(box => box.checked = false);
    });

    document.getElementById("baseGameOnly").addEventListener("click", () => {
      autoSelectBaseGameCourses();
    });

    document.getElementById("randomizeBtn").addEventListener("click", randomize);
  </script>
</body>
</html>
